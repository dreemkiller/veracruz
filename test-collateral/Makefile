# Makefile for test-collateral generation
#
# AUTHORS
#
# The Veracruz Development Team.
#
# COPYRIGHT
#
# See the `LICENSE.markdown` file in the Veracruz root directory for licensing
# and copyright information.

.PHONY: all policy-files clean pgen


WARNING_COLOR := "\e[1;33m"
INFO_COLOR := "\e[1;32m"
RESET_COLOR := "\e[0m"

PLATFORM := $(shell uname)

RUNTIME_MANAGER_CSS_BIN := ../runtime-manager/css.bin
RUNTIME_MANAGER_PCR0 := ../runtime-manager/PCR0

ifeq ($(PLATFORM), Darwin)
	CERTIFICATE_EXPIRY := "$(shell date -Rf +100d)"
endif

ifeq ($(PLATFORM), Linux)
	CERTIFICATE_EXPIRY := "$(shell date --rfc-2822 -d 'now + 100 days')"
endif

POLICY_FILES ?= get_random_policy.json \
 				one_data_source_policy.json \
				two_data_source_string_edit_distance_policy.json \
				two_data_source_intersection_set_policy.json \
				two_data_source_private_set_intersection_policy.json \
				dual_policy.json \
				triple_policy.json \
 				triple_parties_two_data_sources_sum_policy.json \
				permuted_triple_parties_two_data_sources_sum_policy.json \
				triple_parties_two_data_sources_string_edit_distance_policy.json \
				dual_parallel_policy.json \
				quadruple_policy.json \
				test_multiple_key_policy.json \
 				idash2017_logistic_regression_policy.json \
				moving_average_convergence_divergence.json \
 				private_set_intersection_sum.json \
 				number-stream-accumulation.json

WASM_PROG_FILES = random-source.wasm \
				  linear-regression.wasm \
				  string-edit-distance.wasm \
				  intersection-set-sum.wasm \
				  private-set-intersection.wasm \
				  idash2017-logistic-regression.wasm \
				  moving-average-convergence-divergence.wasm \
				  private-set-intersection-sum.wasm \
 				  number-stream-accumulation.wasm

DATA_FILES = linear-regression.dat \
 			 hello-world-1.dat \
 			 hello-world-2.dat \
			 intersection-customer.dat \
             intersection-advertisement-viewer.dat \
			 private-set-1.dat \
			 private-set-2.dat \
			 number-stream-init.dat \
			 number-stream-1.dat \
			 number-stream-2.dat


all: pgen policy-files $(WASM_PROG_FILES) $(DATA_FILES)

pgen:
	$(MAKE) -C generate-policy
	cp generate-policy/target/release/generate-policy ./pgen

policy-files: $(POLICY_FILES)
	@echo $(INFO_COLOR)"GEN   =>  $(POLICY_FILES)"$(RESET_COLOR)

# the css.bin and hash.bin are generated by running "make sgx" in under veracruz-server
$(RUNTIME_MANAGER_CSS_BIN): 
	$(MAKE) clean -C ../runtime-manager
	$(MAKE) css.bin -C ../runtime-manager

css.bin: $(RUNTIME_MANAGER_CSS_BIN)
	$(MAKE) clean -C ../runtime-manager
	$(MAKE) css.bin -C ../runtime-manager
	cp $< $@

get_random_policy.json: pgen pgen $(wildcard css.bin) client_rsa_cert.pem random-source.wasm
	./pgen --certificate client_rsa_cert.pem --roles ProgramProvider,ResultReader \
                --veracruz-server-ip 127.0.0.1:3011 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary random-source.wasm --enclave-debug-mode true --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

one_data_source_policy.json: pgen $(wildcard css.bin) client_rsa_cert.pem linear-regression.wasm
	./pgen --data-provision-order 0 \
		--certificate client_rsa_cert.pem --roles ProgramProvider,DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3012 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary linear-regression.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

test_multiple_key_policy.json: pgen $(wildcard css.bin) client_rsa_cert.pem moving-average-convergence-divergence.wasm
	./pgen --data-provision-order 0 \
		--certificate client_rsa_cert.pem --roles ProgramProvider,DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3012 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary moving-average-convergence-divergence.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

two_data_source_string_edit_distance_policy.json: pgen $(wildcard css.bin) client_rsa_cert.pem string-edit-distance.wasm
	./pgen --data-provision-order 0,0 \
		--certificate client_rsa_cert.pem --roles ProgramProvider,DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3013 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary string-edit-distance.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

two_data_source_intersection_set_policy.json: pgen $(wildcard css.bin) client_rsa_cert.pem intersection-set-sum.wasm
	./pgen --data-provision-order 0,0 \
		--certificate client_rsa_cert.pem --roles ProgramProvider,DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3022 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary intersection-set-sum.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

two_data_source_private_set_intersection_policy.json: pgen $(wildcard css.bin) client_rsa_cert.pem private-set-intersection.wasm
	./pgen --data-provision-order 0,0 \
		--certificate client_rsa_cert.pem --roles ProgramProvider,DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3026 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary private-set-intersection.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

dual_policy.json: pgen $(wildcard css.bin) program_client_cert.pem data_client_cert.pem linear-regression.wasm
	./pgen --data-provision-order 1 \
		--certificate program_client_cert.pem --roles ProgramProvider \
		--certificate data_client_cert.pem --roles DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3014 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary linear-regression.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

dual_parallel_policy.json: pgen $(wildcard css.bin) program_client_cert.pem data_client_cert.pem linear-regression.wasm
	./pgen --data-provision-order 1 \
		--certificate program_client_cert.pem --roles ProgramProvider \
		--certificate data_client_cert.pem --roles DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3015 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary linear-regression.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

triple_policy.json: pgen $(wildcard css.bin) program_client_cert.pem data_client_cert.pem result_client_cert.pem linear-regression.wasm
	./pgen --data-provision-order 1 \
		--certificate program_client_cert.pem --roles ProgramProvider \
		--certificate data_client_cert.pem --roles DataProvider,ResultReader \
		--certificate result_client_cert.pem --roles ResultReader \
		--veracruz-server-ip 127.0.0.1:3016 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary linear-regression.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

triple_parties_two_data_sources_sum_policy.json: pgen $(wildcard css.bin) program_client_cert.pem data_client_cert.pem result_client_cert.pem intersection-set-sum.wasm
	./pgen --data-provision-order 1,2 \
		--certificate program_client_cert.pem --roles ProgramProvider \
		--certificate data_client_cert.pem --roles DataProvider \
		--certificate result_client_cert.pem --roles DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3017 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary intersection-set-sum.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

permuted_triple_parties_two_data_sources_sum_policy.json: pgen $(wildcard css.bin) program_client_cert.pem data_client_cert.pem result_client_cert.pem intersection-set-sum.wasm
	./pgen --data-provision-order 1,2 \
		--certificate program_client_cert.pem --roles ProgramProvider \
		--certificate data_client_cert.pem --roles DataProvider \
		--certificate result_client_cert.pem --roles DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3018 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary intersection-set-sum.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

triple_parties_two_data_sources_string_edit_distance_policy.json: pgen $(wildcard css.bin) program_client_cert.pem data_client_cert.pem result_client_cert.pem string-edit-distance.wasm
	./pgen --data-provision-order 1,2 \
		--certificate program_client_cert.pem --roles ProgramProvider \
		--certificate data_client_cert.pem --roles DataProvider \
		--certificate result_client_cert.pem --roles DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3019 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary string-edit-distance.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

quadruple_policy.json: pgen $(wildcard css.bin) program_client_cert.pem data_client_cert.pem result_client_cert.pem string-edit-distance.wasm
	./pgen --data-provision-order 1,2 \
		--certificate program_client_cert.pem --roles ProgramProvider \
		--certificate data_client_cert.pem --roles DataProvider \
		--certificate never_used_cert.pem --roles DataProvider \
		--certificate result_client_cert.pem --roles ResultReader \
		--veracruz-server-ip 127.0.0.1:3020 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary string-edit-distance.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

invalid_policy/one_expired_data_source_policy.json: pgen $(wildcard css.bin) expired_cert.pem linear-regression.wasm
	./pgen --data-provision-order 0 \
		--certificate expired_cert.pem --roles ProgramProvider,DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3021 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary linear-regression.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

idash2017_logistic_regression_policy.json: pgen $(wildcard css.bin) client_rsa_cert.pem idash2017-logistic-regression.wasm
	./pgen --data-provision-order 0 \
		--certificate client_rsa_cert.pem --roles ProgramProvider,DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3023 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary idash2017-logistic-regression.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

moving_average_convergence_divergence.json: pgen $(wildcard css.bin) client_rsa_cert.pem moving-average-convergence-divergence.wasm
	./pgen --data-provision-order 0 \
		--certificate client_rsa_cert.pem --roles ProgramProvider,DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3024 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary moving-average-convergence-divergence.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

private_set_intersection_sum.json: pgen $(wildcard css.bin) client_rsa_cert.pem private-set-intersection-sum.wasm
	./pgen --data-provision-order 0 \
		--certificate client_rsa_cert.pem --roles ProgramProvider,DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3025 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary private-set-intersection-sum.wasm --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

number-stream-accumulation.json: pgen $(wildcard css.bin) program_client_cert.pem data_client_cert.pem result_client_cert.pem number-stream-accumulation.wasm
	./pgen --data-provision-order 0  --stream-provision-order 0,0 \
		--certificate client_rsa_cert.pem --roles ProgramProvider,DataProvider,ResultReader \
		--veracruz-server-ip 127.0.0.1:3026 --proxy-attestation-server-ip 127.0.0.1:3010 --output-policy-file $@ --certificate-expiry $(CERTIFICATE_EXPIRY) \
		--binary number-stream-accumulation.wasm --enclave-debug-mode true --execution-strategy Interpretation \
		--css-file $(RUNTIME_MANAGER_CSS_BIN) --pcr-file $(RUNTIME_MANAGER_PCR0)

.SECONDEXPANSION:
$(WASM_PROG_FILES) : %.wasm: ../sdk/rust-language-support/examples/%/target/wasm32-arm-veracruz/release/$$@
	cp $< $@

$(DATA_FILES) : %.dat: ../sdk/datasets/%.dat 
	cp $< $@

doc:
	$(MAKE) -C generate-policy doc

clean:
	rm -f pgen
	rm -f *.json
	rm -f css.bin
	rm -f *.dat
	$(MAKE) -C generate-policy clean
	rm -f *.wasm
